#!/bin/sh

# Exit on error
set -e

echo "ğŸ” Running pre-commit checks..."

# Get list of staged files (save for re-staging after formatters run)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)
STAGED_FILES_LIST=$(echo "$STAGED_FILES" | tr '\n' ' ')

# Check if any TypeScript/JavaScript files are staged
HAS_TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)

# Check if any Rust files are staged
HAS_RS_FILES=$(echo "$STAGED_FILES" | grep -E '\.rs$' || true)

# Check if any package.json files are staged
HAS_PKG_FILES=$(echo "$STAGED_FILES" | grep 'package\.json$' || true)

# 1. Biome: Format + Lint TypeScript/JavaScript/JSON (staged files only, with fixes)
echo "ğŸ“ Biome: Formatting and linting staged TS/JS/JSON files..."
bunx @biomejs/biome check --write --staged --files-ignore-unknown=true --no-errors-on-unmatched

# 2. TypeScript: Type checking (if TS/JS files are staged)
if [ -n "$HAS_TS_FILES" ]; then
  echo "ğŸ”· TypeScript: Running type checker..."
  bun run typecheck || {
    echo "âŒ TypeScript type errors found. Please fix them before committing."
    exit 1
  }
fi

# 3. Cargo: Format Rust (if Rust files exist)
if [ -d "apps/execution-engine" ]; then
  echo "ğŸ¦€ Cargo: Formatting Rust files..."
  cargo fmt --all 2>/dev/null || true

  # 4. Clippy: Lint Rust (includes type checking)
  # Use -D clippy::correctness for actual bugs, allow style/complexity lints
  echo "ğŸ¦€ Clippy: Checking Rust files..."
  cargo clippy --all-targets --all-features -- \
    -D clippy::correctness \
    -W clippy::all \
    2>/dev/null || {
    echo "âŒ Rust errors found. Please fix them before committing."
    exit 1
  }
fi

# 5. Dependency validation (if package.json files are staged)
if [ -n "$HAS_PKG_FILES" ]; then
  echo "ğŸ“¦ Validating package dependencies..."
  bun run lint:deps || {
    echo "âŒ Dependency validation failed. Please fix circular or invalid dependencies."
    exit 1
  }
fi

# Re-stage only the originally staged files (in case formatters modified them)
if [ -n "$STAGED_FILES_LIST" ]; then
  echo "ğŸ“¦ Re-staging fixed files..."
  echo "$STAGED_FILES_LIST" | xargs git add --
fi

echo "âœ… Pre-commit checks complete!"
