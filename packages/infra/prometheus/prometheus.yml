# Prometheus Configuration - Cream Trading System
# ================================================
# Reference: docs/plans/09-rust-core.md
#
# Scrape targets:
# - execution-engine: Rust core (port 9090)
# - otel-collector: OpenTelemetry metrics (port 8888)
#
# Rules:
# - recording_rules.yml: SLI precomputation
# - alerts.yml: SLO and operational alerts

global:
  scrape_interval: 15s       # Default scrape interval
  evaluation_interval: 15s   # Rule evaluation interval
  scrape_timeout: 10s        # Scrape timeout

  # Labels added to all time series
  external_labels:
    environment: "${CREAM_ENV:-PAPER}"
    cluster: "cream-trading"

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Rule files
rule_files:
  - "recording_rules.yml"
  - "alerts.yml"

# Scrape configurations
scrape_configs:
  # Execution Engine (Rust Core)
  # Exposes metrics on port 9090
  - job_name: "execution-engine"
    static_configs:
      - targets: ["execution-engine:9090"]
        labels:
          service: "execution-engine"
    metrics_path: /metrics
    scheme: http
    # Relabel to add environment label
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: "([^:]+):.+"
        replacement: "${1}"

  # OpenTelemetry Collector (exports metrics to Prometheus)
  - job_name: "otel-collector"
    static_configs:
      - targets: ["otel-collector:8888"]
        labels:
          service: "otel-collector"
    metrics_path: /metrics
    scheme: http

  # Prometheus self-monitoring
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
        labels:
          service: "prometheus"

  # Node Exporter (host metrics) - optional
  # - job_name: "node"
  #   static_configs:
  #     - targets: ["node-exporter:9100"]

# Remote write configuration (for long-term storage)
# Uncomment and configure for production
# remote_write:
#   - url: "http://thanos-receive:19291/api/v1/receive"
#     queue_config:
#       max_samples_per_send: 10000
#       max_shards: 200
#       capacity: 2500

# Storage configuration
# Uncomment for production tuning
# storage:
#   tsdb:
#     retention.time: 15d
#     retention.size: 50GB
