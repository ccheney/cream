# Alertmanager Configuration - Cream Trading System
# ==================================================
# Routes alerts to appropriate receivers based on labels.
#
# Environment variables for production deployment:
# - SLACK_WEBHOOK_URL: Slack incoming webhook URL
# - SLACK_CHANNEL_CRITICAL: Channel for critical alerts (default: #alerts-critical)
# - SLACK_CHANNEL_SLO: Channel for SLO alerts (default: #alerts-slo)
# - PAGERDUTY_SERVICE_KEY: PagerDuty integration key
# - SMTP_SMARTHOST: SMTP server (e.g., smtp.example.com:587)
# - SMTP_FROM: Alert sender email
# - SMTP_USERNAME: SMTP auth username
# - SMTP_PASSWORD: SMTP auth password
# - ALERT_EMAIL: Team email for notifications

global:
  # SMTP configuration for email notifications
  # In production, set SMTP_SMARTHOST env var; dev uses localhost
  smtp_smarthost: 'localhost:25'
  smtp_from: 'alertmanager@cream.broker'
  smtp_require_tls: false

  # Slack webhook URL (placeholder for dev - set SLACK_WEBHOOK_URL in production)
  slack_api_url: 'https://hooks.slack.com/services/placeholder'

  # Resolve timeout (when alerts are considered resolved)
  resolve_timeout: 5m

# Route tree
route:
  # Default receiver
  receiver: "default"

  # Group by alertname and team
  group_by: ["alertname", "team", "slo"]

  # Wait before sending initial notification
  group_wait: 30s

  # Wait before sending updated notification
  group_interval: 5m

  # Minimum interval between notifications
  repeat_interval: 4h

  # Child routes
  routes:
    # Critical alerts: immediate notification to PagerDuty + Slack
    - match:
        severity: critical
      receiver: "critical"
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # SLO alerts: route to SLO channel
    - match_re:
        slo: ".+"
      receiver: "slo-violations"
      group_by: ["alertname", "slo", "team"]
      group_wait: 1m
      repeat_interval: 2h

    # Fast burn alerts: highest priority
    - match:
        burn_type: fast
      receiver: "critical"
      group_wait: 10s
      repeat_interval: 30m

    # Slow burn alerts: elevated priority
    - match:
        burn_type: slow
      receiver: "slo-violations"
      group_wait: 2m
      repeat_interval: 1h

    # Warning alerts: less urgent
    - match:
        severity: warning
      receiver: "warnings"
      group_wait: 5m
      repeat_interval: 12h

# Inhibition rules
inhibit_rules:
  # If critical alert fires, inhibit warnings for same alertname
  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal: ["alertname", "team"]

  # If execution engine is down, inhibit dependent alerts
  - source_match:
      alertname: ExecutionEngineDown
    target_match_re:
      alertname: "(Order|Feed|Greeks|Grpc).*"
    equal: ["instance"]

  # Fast burn inhibits slow burn for same SLO
  - source_match:
      burn_type: fast
    target_match:
      burn_type: slow
    equal: ["slo"]

# Receivers
receivers:
  # Default receiver (development: webhook for testing)
  - name: "default"
    webhook_configs:
      - url: 'http://localhost:9000/webhook'
        send_resolved: true

  # Critical alerts: Slack (PagerDuty disabled in dev)
  - name: "critical"
    slack_configs:
      - channel: '#alerts-critical'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: '{{ if eq .Status "firing" }}:rotating_light:{{ else }}:white_check_mark:{{ end }} {{ .GroupLabels.alertname }}'
        text: |
          *Summary:* {{ .CommonAnnotations.summary }}
          *Severity:* {{ .CommonLabels.severity }}
          *Team:* {{ .CommonLabels.team }}
          {{ range .Alerts }}
          *Description:* {{ .Annotations.description }}
          {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        actions:
          - type: button
            text: 'Runbook :book:'
            url: '{{ (index .Alerts 0).Annotations.runbook_url }}'
          - type: button
            text: 'Dashboard :chart_with_upwards_trend:'
            url: 'http://grafana:3000/d/slo-overview'

  # SLO violation alerts: Slack SLO channel
  - name: "slo-violations"
    slack_configs:
      - channel: '#alerts-slo'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        title: '{{ if eq .Status "firing" }}:warning:{{ else }}:white_check_mark:{{ end }} SLO: {{ .GroupLabels.slo }}'
        text: |
          *Alert:* {{ .GroupLabels.alertname }}
          *SLO:* {{ .GroupLabels.slo }}
          *Team:* {{ .CommonLabels.team }}
          {{ if .CommonLabels.burn_type }}*Burn Rate:* {{ .CommonLabels.burn_type }}{{ end }}
          {{ range .Alerts }}
          {{ .Annotations.description }}
          {{ end }}
        actions:
          - type: button
            text: 'SLO Dashboard'
            url: 'http://grafana:3000/d/slo-overview'

  # Warning alerts: Email
  - name: "warnings"
    email_configs:
      - to: 'team@cream.broker'
        send_resolved: true
        html: |
          <h2>{{ .GroupLabels.alertname }}</h2>
          <p><strong>Status:</strong> {{ .Status }}</p>
          <p><strong>Severity:</strong> {{ .CommonLabels.severity }}</p>
          {{ range .Alerts }}
          <hr>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p>{{ .Annotations.description }}</p>
          {{ if .Annotations.runbook_url }}<p><a href="{{ .Annotations.runbook_url }}">Runbook</a></p>{{ end }}
          {{ end }}

# Templates for notification formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'
