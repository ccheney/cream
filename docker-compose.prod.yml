# Cream Trading Dashboard - Production Docker Compose
#
# Deploy the full dashboard stack with automatic HTTPS.
#
# Usage:
#   1. Copy .env.live.example to .env.live and fill in secrets
#   2. docker compose -f docker-compose.prod.yml build
#   3. docker compose -f docker-compose.prod.yml up -d
#
# Scaling:
#   docker compose -f docker-compose.prod.yml up -d --scale dashboard-api=2
#
# Logs:
#   docker compose -f docker-compose.prod.yml logs -f [service]

services:
  # ==========================================
  # Caddy - Reverse Proxy with Auto-HTTPS
  # ==========================================
  caddy:
    image: caddy:2-alpine
    container_name: cream-caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp" # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
    environment:
      - DASHBOARD_HOST=${DASHBOARD_HOST:-cream.broker}
      - API_HOST=${API_HOST:-api.cream.broker}
      - OBSERVE_HOST=${OBSERVE_HOST:-observe.cream.broker}
      - DASHBOARD_UPSTREAM=dashboard:3000
      - API_UPSTREAM=dashboard-api:3001
    depends_on:
      dashboard:
        condition: service_healthy
      dashboard-api:
        condition: service_healthy
      openobserve:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cream-network

  # ==========================================
  # Dashboard - Next.js Frontend
  # ==========================================
  dashboard:
    build:
      context: .
      dockerfile: apps/dashboard/Dockerfile
    container_name: cream-dashboard
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://${API_HOST:-api.cream.broker}
      - NEXT_PUBLIC_WS_URL=wss://${API_HOST:-api.cream.broker}/ws
    restart: unless-stopped
    networks:
      - cream-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # Dashboard API - Hono REST + WebSocket
  # ==========================================
  dashboard-api:
    build:
      context: .
      dockerfile: apps/dashboard-api/Dockerfile
    container_name: cream-dashboard-api
    environment:
      - NODE_ENV=production
      - CREAM_ENV=${CREAM_ENV:-PAPER}
      - DATABASE_URL=${DATABASE_URL}
      - ALLOWED_ORIGINS=https://${DASHBOARD_HOST:-cream.broker}
      - HELIX_URL=${HELIX_URL:-}
      # OpenTelemetry
      - OTEL_ENABLED=${OTEL_ENABLED:-true}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=cream-dashboard-api
    depends_on:
      otel-collector:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cream-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================
  # Worker - Hourly Scheduler
  # ==========================================
  worker:
    build:
      context: .
      dockerfile: apps/worker/Dockerfile
    container_name: cream-worker
    env_file:
      - .env.live
    environment:
      - NODE_ENV=production
      - CREAM_ENV=${CREAM_ENV:-PAPER}
      - DATABASE_URL=${DATABASE_URL}
      - HELIX_URL=${HELIX_URL:-}
      # OpenTelemetry
      - OTEL_ENABLED=${OTEL_ENABLED:-true}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=cream-worker
    depends_on:
      dashboard-api:
        condition: service_healthy
      otel-collector:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cream-network

  # ==========================================
  # OpenObserve - Observability Platform
  # ==========================================
  # Web UI: https://${OBSERVE_HOST:-observe.cream.broker}
  # Credentials configured via ZO_ROOT_USER_EMAIL and ZO_ROOT_USER_PASSWORD
  openobserve:
    image: public.ecr.aws/zinclabs/openobserve:v0.50.0-rc3
    container_name: cream-openobserve
    restart: unless-stopped
    environment:
      - ZO_DATA_DIR=/data
      - ZO_ROOT_USER_EMAIL=${ZO_ROOT_USER_EMAIL:-admin@cream.broker}
      - ZO_ROOT_USER_PASSWORD=${ZO_ROOT_USER_PASSWORD}
      - ZO_TELEMETRY=false
      - ZO_WEB_URL=https://${OBSERVE_HOST:-observe.cream.broker}
    volumes:
      - openobserve_data:/data
    networks:
      - cream-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:5080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================
  # OpenTelemetry Collector
  # ==========================================
  # Receives OTLP from services and forwards to OpenObserve
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.116.1
    container_name: cream-otel-collector
    restart: unless-stopped
    command:
      - --config=/etc/otel-collector-config.yaml
    environment:
      - ZO_AUTH_TOKEN=${ZO_AUTH_TOKEN}
    volumes:
      - ./packages/infra/observability/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    depends_on:
      openobserve:
        condition: service_healthy
    networks:
      - cream-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:13133/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # PostgreSQL Database
  # ==========================================
  # External PostgreSQL database is expected. Set DATABASE_URL in .env.live
  # pointing to your PostgreSQL instance (local, Supabase, Neon, etc.)

# ==========================================
# Volumes
# ==========================================
volumes:
  caddy_data:
    name: cream_caddy_data
  caddy_config:
    name: cream_caddy_config
  caddy_logs:
    name: cream_caddy_logs
  openobserve_data:
    name: cream_openobserve_data

# ==========================================
# Networks
# ==========================================
networks:
  cream-network:
    name: cream-network
    driver: bridge
