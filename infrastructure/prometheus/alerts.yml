# SLO Alert Rules - Cream Trading System
# ========================================
# Implements SLO-based alerting using multi-window burn rate strategy.
#
# Reference: docs/plans/09-rust-core.md (lines 854-1138)
#
# Alerting Strategy (Google SRE recommended):
# - Fast burn: 14.4x burn rate, 1h window (critical, exhausts budget in 2 days)
# - Slow burn: 6x burn rate, 6h window (warning, gradual degradation)
# - Short windows: 1/12 of long window to minimize reset time
#
# SLO Targets:
# | Service            | SLI           | SLO Target | Error Budget (30d) |
# |--------------------|---------------|------------|---------------------|
# | Order Execution    | Success rate  | 99.9%      | 43.2 minutes        |
# | Order Execution    | P99 latency   | < 500ms    | -                   |
# | Market Data Feed   | Availability  | 99.95%     | 21.6 minutes        |
# | Market Data Feed   | P99 latency   | < 10ms     | -                   |
# | Greeks Computation | P99 latency   | < 50ms     | -                   |
# | gRPC API           | Success rate  | 99.9%      | 43.2 minutes        |

groups:
  # ============================================
  # SLO Violation Alerts
  # ============================================
  - name: slo_alerts
    rules:
      # Order Execution Success Rate SLO (99.9%)
      - alert: OrderExecutionSLOViolation
        expr: sli:order_execution:success_rate:5m < 0.999
        for: 2m
        labels:
          severity: critical
          slo: order_execution_success
          team: trading
        annotations:
          summary: "Order execution success rate below 99.9% SLO"
          description: |
            Order execution success rate is {{ $value | humanizePercentage }}.
            SLO target: 99.9%
            Error budget: 43.2 minutes/month
          runbook_url: "https://docs.cream.dev/runbooks/order-execution-slo"

      # Order Execution Latency SLO (P99 < 500ms)
      - alert: OrderLatencySLOViolation
        expr: sli:order_execution:latency_p99:5m > 0.5
        for: 5m
        labels:
          severity: warning
          slo: order_execution_latency
          team: trading
        annotations:
          summary: "Order P99 latency above 500ms SLO"
          description: |
            Order P99 latency is {{ $value | humanizeDuration }}.
            SLO target: < 500ms
          runbook_url: "https://docs.cream.dev/runbooks/order-latency-slo"

      # Market Data Feed Availability SLO (99.95%)
      - alert: FeedAvailabilitySLOViolation
        expr: sli:feed:availability:5m < 0.9995
        for: 1m
        labels:
          severity: critical
          slo: feed_availability
          team: data
        annotations:
          summary: "Market data feed availability below 99.95% SLO"
          description: |
            Feed availability is {{ $value | humanizePercentage }}.
            SLO target: 99.95%
            Error budget: 21.6 minutes/month
          runbook_url: "https://docs.cream.dev/runbooks/feed-availability-slo"

      # Market Data Feed Latency SLO (P99 < 10ms)
      - alert: FeedLatencySLOViolation
        expr: sli:feed:latency_p99:5m > 0.010
        for: 2m
        labels:
          severity: warning
          slo: feed_latency
          team: data
        annotations:
          summary: "Feed P99 latency above 10ms SLO"
          description: |
            Feed P99 latency is {{ $value | humanizeDuration }}.
            SLO target: < 10ms
          runbook_url: "https://docs.cream.dev/runbooks/feed-latency-slo"

      # Greeks Computation Latency SLO (P99 < 50ms)
      - alert: GreeksLatencySLOViolation
        expr: sli:greeks:latency_p99:5m > 0.050
        for: 5m
        labels:
          severity: warning
          slo: greeks_latency
          team: analytics
        annotations:
          summary: "Greeks P99 latency above 50ms SLO"
          description: |
            Greeks computation P99 latency is {{ $value | humanizeDuration }}.
            SLO target: < 50ms
          runbook_url: "https://docs.cream.dev/runbooks/greeks-latency-slo"

      # gRPC API Success Rate SLO (99.9%)
      - alert: GrpcApiSLOViolation
        expr: sli:grpc:success_rate:5m < 0.999
        for: 2m
        labels:
          severity: critical
          slo: grpc_success
          team: platform
        annotations:
          summary: "gRPC API success rate below 99.9% SLO"
          description: |
            gRPC success rate is {{ $value | humanizePercentage }}.
            SLO target: 99.9%
            Error budget: 43.2 minutes/month
          runbook_url: "https://docs.cream.dev/runbooks/grpc-api-slo"

  # ============================================
  # Multi-Window Burn Rate Alerts
  # ============================================
  - name: error_budget_alerts
    rules:
      # Fast Burn - Order Execution (14.4x rate, 1h window)
      # At 14.4x burn rate, 30-day error budget exhausted in ~2 days
      - alert: OrderExecutionErrorBudgetFastBurn
        expr: |
          (
            sli:order_execution:error_rate:1h > (14.4 * 0.001)
          ) and (
            sum(rate(order_submissions_total{status!="success"}[5m])) /
            sum(rate(order_submissions_total[5m])) > (14.4 * 0.001)
          )
        for: 2m
        labels:
          severity: critical
          slo: order_execution_success
          burn_type: fast
          team: trading
        annotations:
          summary: "Order execution error budget burning at 14.4x rate (fast burn)"
          description: |
            Error budget is being consumed at 14.4x the sustainable rate.
            At this rate, the monthly error budget will be exhausted in ~2 days.
            Immediate investigation required.
          runbook_url: "https://docs.cream.dev/runbooks/error-budget-fast-burn"

      # Slow Burn - Order Execution (6x rate, 6h window)
      # Detects gradual SLO degradation over longer time
      - alert: OrderExecutionErrorBudgetSlowBurn
        expr: |
          (
            sli:order_execution:error_rate:6h > (6 * 0.001)
          ) and (
            sum(rate(order_submissions_total{status!="success"}[30m])) /
            sum(rate(order_submissions_total[30m])) > (6 * 0.001)
          )
        for: 15m
        labels:
          severity: warning
          slo: order_execution_success
          burn_type: slow
          team: trading
        annotations:
          summary: "Order execution error budget burning at 6x rate (slow burn)"
          description: |
            Error budget is being consumed at 6x the sustainable rate.
            Gradual SLO degradation detected over 6-hour window.
            Investigation recommended.
          runbook_url: "https://docs.cream.dev/runbooks/error-budget-slow-burn"

      # Fast Burn - gRPC API (14.4x rate, 1h window)
      - alert: GrpcApiErrorBudgetFastBurn
        expr: |
          (
            sli:grpc:error_rate:1h > (14.4 * 0.001)
          ) and (
            1 - (
              sum(rate(grpc_requests_total{status=~"OK|0"}[5m])) /
              sum(rate(grpc_requests_total[5m]))
            ) > (14.4 * 0.001)
          )
        for: 2m
        labels:
          severity: critical
          slo: grpc_success
          burn_type: fast
          team: platform
        annotations:
          summary: "gRPC API error budget burning at 14.4x rate (fast burn)"
          description: |
            gRPC error budget is being consumed at 14.4x the sustainable rate.
            At this rate, the monthly error budget will be exhausted in ~2 days.
          runbook_url: "https://docs.cream.dev/runbooks/error-budget-fast-burn"

      # Slow Burn - gRPC API (6x rate, 6h window)
      - alert: GrpcApiErrorBudgetSlowBurn
        expr: |
          (
            sli:grpc:error_rate:6h > (6 * 0.001)
          ) and (
            1 - (
              sum(rate(grpc_requests_total{status=~"OK|0"}[30m])) /
              sum(rate(grpc_requests_total[30m]))
            ) > (6 * 0.001)
          )
        for: 15m
        labels:
          severity: warning
          slo: grpc_success
          burn_type: slow
          team: platform
        annotations:
          summary: "gRPC API error budget burning at 6x rate (slow burn)"
          description: |
            gRPC error budget is being consumed at 6x the sustainable rate.
            Gradual SLO degradation detected over 6-hour window.
          runbook_url: "https://docs.cream.dev/runbooks/error-budget-slow-burn"

  # ============================================
  # Component-Specific Alerts
  # ============================================
  - name: execution_engine
    rules:
      # High order rejection rate (operational alert, not SLO)
      - alert: HighOrderRejectionRate
        expr: |
          sum(rate(order_submissions_total{status="rejected"}[5m])) /
          sum(rate(order_submissions_total[5m])) > 0.01
        for: 2m
        labels:
          severity: critical
          team: trading
        annotations:
          summary: "Order rejection rate > 1%"
          description: |
            {{ $value | humanizePercentage }} of orders are being rejected.
            Check constraint violations, buying power, or broker issues.
          runbook_url: "https://docs.cream.dev/runbooks/high-rejection-rate"

      # Market data feed staleness
      - alert: MarketDataStale
        expr: feed_last_message_age_seconds > 5
        for: 30s
        labels:
          severity: critical
          team: data
        annotations:
          summary: "Market data feed stale for {{ $labels.provider }}"
          description: |
            No market data received for {{ $value | humanizeDuration }}.
            Provider: {{ $labels.provider }}
            Feed: {{ $labels.feed }}
          runbook_url: "https://docs.cream.dev/runbooks/stale-market-data"

      # Circuit breaker open
      - alert: CircuitBreakerOpen
        expr: circuit_breaker_state == 1
        for: 1m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Circuit breaker open for {{ $labels.service }}"
          description: |
            Circuit breaker for {{ $labels.service }} is in OPEN state.
            Requests are being rejected to protect downstream services.
          runbook_url: "https://docs.cream.dev/runbooks/circuit-breaker-open"

      # High feed gap rate (sequence number gaps)
      - alert: HighFeedGapRate
        expr: rate(feed_gaps_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          team: data
        annotations:
          summary: "High sequence gap rate on {{ $labels.provider }}"
          description: |
            {{ $value | humanize }} sequence gaps per second detected.
            Provider: {{ $labels.provider }}
            This may indicate network issues or data loss.
          runbook_url: "https://docs.cream.dev/runbooks/feed-gaps"

      # Quote staleness
      - alert: QuoteStale
        expr: quote_staleness_seconds > 1
        for: 30s
        labels:
          severity: warning
          team: data
        annotations:
          summary: "Stale quote data for {{ $labels.symbol }}"
          description: |
            Quote for {{ $labels.symbol }} is {{ $value | humanizeDuration }} old.
            Trading decisions may be based on outdated prices.
          runbook_url: "https://docs.cream.dev/runbooks/stale-quotes"

  # ============================================
  # Latency Percentile Alerts (by Component)
  # ============================================
  - name: latency_alerts
    rules:
      # Order Submit P95 Warning (200ms threshold)
      - alert: OrderSubmitLatencyP95Warning
        expr: |
          histogram_quantile(0.95,
            sum(rate(order_latency_seconds_bucket[5m])) by (le, broker)
          ) > 0.2
        for: 5m
        labels:
          severity: warning
          component: order_submit
        annotations:
          summary: "Order submit P95 latency > 200ms"
          description: "P95 latency: {{ $value | humanizeDuration }} for broker {{ $labels.broker }}"

      # Feed Message P95 Warning (5ms threshold)
      - alert: FeedMessageLatencyP95Warning
        expr: |
          histogram_quantile(0.95,
            sum(rate(feed_latency_seconds_bucket[5m])) by (le, provider)
          ) > 0.005
        for: 2m
        labels:
          severity: warning
          component: feed_message
        annotations:
          summary: "Feed message P95 latency > 5ms"
          description: "P95 latency: {{ $value | humanizeDuration }} for provider {{ $labels.provider }}"

      # Greeks Computation P95 Warning (25ms threshold)
      - alert: GreeksComputationLatencyP95Warning
        expr: |
          histogram_quantile(0.95,
            sum(rate(greeks_computation_seconds_bucket[5m])) by (le, model)
          ) > 0.025
        for: 5m
        labels:
          severity: warning
          component: greeks
        annotations:
          summary: "Greeks computation P95 latency > 25ms"
          description: "P95 latency: {{ $value | humanizeDuration }} for model {{ $labels.model }}"

      # gRPC Request P95 Warning (50ms threshold)
      - alert: GrpcRequestLatencyP95Warning
        expr: |
          histogram_quantile(0.95,
            sum(rate(grpc_request_duration_seconds_bucket[5m])) by (le, method)
          ) > 0.050
        for: 5m
        labels:
          severity: warning
          component: grpc
        annotations:
          summary: "gRPC request P95 latency > 50ms"
          description: "P95 latency: {{ $value | humanizeDuration }} for method {{ $labels.method }}"

      # gRPC Request P99 Critical (200ms threshold)
      - alert: GrpcRequestLatencyP99Critical
        expr: |
          histogram_quantile(0.99,
            sum(rate(grpc_request_duration_seconds_bucket[5m])) by (le, method)
          ) > 0.2
        for: 5m
        labels:
          severity: critical
          component: grpc
        annotations:
          summary: "gRPC request P99 latency > 200ms"
          description: "P99 latency: {{ $value | humanizeDuration }} for method {{ $labels.method }}"

  # ============================================
  # Infrastructure Alerts
  # ============================================
  - name: infrastructure
    rules:
      # Execution engine down
      - alert: ExecutionEngineDown
        expr: up{job="execution-engine"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Execution engine is down"
          description: |
            The execution engine at {{ $labels.instance }} is not responding.
            Trading operations may be impacted.
          runbook_url: "https://docs.cream.dev/runbooks/execution-engine-down"

      # High memory usage
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes{job="execution-engine"} > 2e9
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Execution engine memory usage > 2GB"
          description: |
            Memory usage: {{ $value | humanize1024 }}B
            Instance: {{ $labels.instance }}

      # Metrics endpoint unavailable
      - alert: MetricsEndpointDown
        expr: up{job="execution-engine"} == 0
        for: 30s
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Metrics endpoint unavailable"
          description: "Cannot scrape metrics from {{ $labels.instance }}"
