# SLO Recording Rules - Cream Trading System
# =============================================
# Precomputes SLI (Service Level Indicator) metrics for efficient alerting.
# Uses 5-minute windows for responsiveness while avoiding noise.
#
# Reference: docs/plans/09-rust-core.md (lines 876-966)
#
# SLO Targets:
# - Order Execution: 99.9% success rate, P99 < 500ms
# - Market Data Feed: 99.95% availability, P99 < 10ms
# - Greeks Computation: P99 < 50ms
# - gRPC API: 99.9% success rate

groups:
  - name: slo_recording_rules
    interval: 30s
    rules:
      # ============================================
      # Order Execution SLIs
      # ============================================

      # Recording rule: Order execution success rate (SLI)
      # Target: 99.9% (error budget: 43.2 minutes/30 days)
      - record: sli:order_execution:success_rate:5m
        expr: |
          sum(rate(order_submissions_total{status="success"}[5m])) /
          sum(rate(order_submissions_total[5m]))

      # Recording rule: Order execution P99 latency (SLI)
      # Target: < 500ms
      - record: sli:order_execution:latency_p99:5m
        expr: |
          histogram_quantile(0.99,
            sum(rate(order_latency_seconds_bucket[5m])) by (le, broker)
          )

      # Recording rule: Order execution P95 latency
      # Used for trending and capacity planning
      - record: sli:order_execution:latency_p95:5m
        expr: |
          histogram_quantile(0.95,
            sum(rate(order_latency_seconds_bucket[5m])) by (le, broker)
          )

      # Recording rule: Order execution P50 latency
      # Used for baseline performance monitoring
      - record: sli:order_execution:latency_p50:5m
        expr: |
          histogram_quantile(0.50,
            sum(rate(order_latency_seconds_bucket[5m])) by (le, broker)
          )

      # ============================================
      # Market Data Feed SLIs
      # ============================================

      # Recording rule: Market data feed availability (SLI)
      # Target: 99.95% (error budget: 21.6 minutes/30 days)
      - record: sli:feed:availability:5m
        expr: |
          avg_over_time((up{job="execution-engine", feed="databento"}[5m]))

      # Recording rule: Market data feed P99 latency (SLI)
      # Target: < 10ms
      - record: sli:feed:latency_p99:5m
        expr: |
          histogram_quantile(0.99,
            sum(rate(feed_latency_seconds_bucket[5m])) by (le, provider)
          )

      # Recording rule: Market data feed P95 latency
      - record: sli:feed:latency_p95:5m
        expr: |
          histogram_quantile(0.95,
            sum(rate(feed_latency_seconds_bucket[5m])) by (le, provider)
          )

      # Recording rule: Feed message rate (for capacity planning)
      - record: sli:feed:message_rate:5m
        expr: |
          sum(rate(feed_messages_total[5m])) by (provider)

      # ============================================
      # Greeks Computation SLIs
      # ============================================

      # Recording rule: Greeks computation P99 latency (SLI)
      # Target: < 50ms
      - record: sli:greeks:latency_p99:5m
        expr: |
          histogram_quantile(0.99,
            sum(rate(greeks_computation_seconds_bucket[5m])) by (le, model)
          )

      # Recording rule: Greeks computation P95 latency
      - record: sli:greeks:latency_p95:5m
        expr: |
          histogram_quantile(0.95,
            sum(rate(greeks_computation_seconds_bucket[5m])) by (le, model)
          )

      # Recording rule: Greeks computation rate
      - record: sli:greeks:computation_rate:5m
        expr: |
          sum(rate(greeks_computations_total[5m])) by (model)

      # ============================================
      # gRPC API SLIs
      # ============================================

      # Recording rule: gRPC API success rate (SLI)
      # Target: 99.9% (error budget: 43.2 minutes/30 days)
      - record: sli:grpc:success_rate:5m
        expr: |
          sum(rate(grpc_requests_total{status=~"OK|0"}[5m])) /
          sum(rate(grpc_requests_total[5m]))

      # Recording rule: gRPC API P99 latency
      - record: sli:grpc:latency_p99:5m
        expr: |
          histogram_quantile(0.99,
            sum(rate(grpc_request_duration_seconds_bucket[5m])) by (le, method)
          )

      # Recording rule: gRPC API P95 latency
      - record: sli:grpc:latency_p95:5m
        expr: |
          histogram_quantile(0.95,
            sum(rate(grpc_request_duration_seconds_bucket[5m])) by (le, method)
          )

      # Recording rule: gRPC request rate by method
      - record: sli:grpc:request_rate:5m
        expr: |
          sum(rate(grpc_requests_total[5m])) by (method)

      # ============================================
      # Error Budget Burn Rate (for multi-window alerting)
      # ============================================

      # Order execution error rate (1 - success_rate)
      - record: sli:order_execution:error_rate:1h
        expr: |
          1 - (
            sum(rate(order_submissions_total{status="success"}[1h])) /
            sum(rate(order_submissions_total[1h]))
          )

      - record: sli:order_execution:error_rate:6h
        expr: |
          1 - (
            sum(rate(order_submissions_total{status="success"}[6h])) /
            sum(rate(order_submissions_total[6h]))
          )

      # gRPC API error rate
      - record: sli:grpc:error_rate:1h
        expr: |
          1 - (
            sum(rate(grpc_requests_total{status=~"OK|0"}[1h])) /
            sum(rate(grpc_requests_total[1h]))
          )

      - record: sli:grpc:error_rate:6h
        expr: |
          1 - (
            sum(rate(grpc_requests_total{status=~"OK|0"}[6h])) /
            sum(rate(grpc_requests_total[6h]))
          )
