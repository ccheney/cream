name: Deploy

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      force_deploy_all:
        description: 'Force deploy all services'
        required: false
        default: 'false'
        type: boolean
      force_infra:
        description: 'Force infrastructure apply'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  DOMAIN: cream.broker
  DEPLOY_USER: cream
  DEPLOY_PATH: /home/cream/cream

jobs:
  # Wait for CI to pass
  ci:
    uses: ./.github/workflows/test.yml
    secrets: inherit

  # Detect which components changed
  changes:
    runs-on: ubuntu-latest
    needs: ci
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      dashboard: ${{ steps.filter.outputs.dashboard }}
      dashboard_api: ${{ steps.filter.outputs.dashboard_api }}
      worker: ${{ steps.filter.outputs.worker }}
      docker_compose: ${{ steps.filter.outputs.docker_compose }}
      caddy: ${{ steps.filter.outputs.caddy }}
      any_service: ${{ steps.any.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - 'packages/infra/*.tf'
            dashboard:
              - 'apps/dashboard/**'
              - 'packages/dashboard-types/**'
            dashboard_api:
              - 'apps/dashboard-api/**'
              - 'packages/domain/**'
              - 'packages/storage/**'
              - 'packages/config/**'
              - 'packages/broker/**'
              - 'packages/marketdata/**'
              - 'packages/research/**'
            worker:
              - 'apps/worker/**'
              - 'apps/api/**'
              - 'packages/mastra-kit/**'
              - 'packages/domain/**'
              - 'packages/storage/**'
              - 'packages/config/**'
            docker_compose:
              - 'docker-compose.prod.yml'
            caddy:
              - 'Caddyfile'

      - name: Check if any service changed
        id: any
        run: |
          if [[ "${{ steps.filter.outputs.dashboard }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.dashboard_api }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.worker }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.docker_compose }}" == "true" ]] || \
             [[ "${{ inputs.force_deploy_all }}" == "true" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  # Infrastructure deployment with OpenTofu
  infrastructure:
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      always() &&
      needs.changes.result == 'success' &&
      (needs.changes.outputs.infra == 'true' || inputs.force_infra == true)
    environment: production
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.8.0

      - name: OpenTofu Init
        working-directory: packages/infra
        run: tofu init

      - name: OpenTofu Validate
        working-directory: packages/infra
        run: tofu validate

      - name: OpenTofu Plan
        working-directory: packages/infra
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          TF_VAR_vercel_api_token: ${{ secrets.VERCEL_API_TOKEN }}
          TF_VAR_domain: ${{ env.DOMAIN }}
        run: tofu plan -out=tfplan -no-color

      - name: OpenTofu Apply
        working-directory: packages/infra
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          TF_VAR_vercel_api_token: ${{ secrets.VERCEL_API_TOKEN }}
          TF_VAR_domain: ${{ env.DOMAIN }}
        run: tofu apply -auto-approve tfplan

      - name: Get Server IP
        id: server
        working-directory: packages/infra
        run: echo "ip=$(tofu output -raw server_ip)" >> $GITHUB_OUTPUT

    outputs:
      server_ip: ${{ steps.server.outputs.ip }}

  # Sync files to server
  sync:
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      always() &&
      needs.changes.result == 'success' &&
      needs.changes.outputs.any_service == 'true'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          for i in {1..3}; do
            if ssh-keyscan -T 30 -H ${{ env.DOMAIN }} >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "SSH key scan successful"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "::error::Failed to scan SSH host after 3 attempts"
          exit 1

      - name: Sync files to server
        run: |
          rsync -avz --delete --no-group --no-owner \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.venv' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude 'dist' \
            --exclude '.turbo' \
            --exclude '.next' \
            --exclude '.terraform' \
            --exclude 'terraform.tfstate*' \
            --exclude '*.tfvars' \
            . ${{ env.DEPLOY_USER }}@${{ env.DOMAIN }}:${{ env.DEPLOY_PATH }}/

      - name: Create .env file on server
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=20 ${{ env.DEPLOY_USER }}@${{ env.DOMAIN }} "cat > ${{ env.DEPLOY_PATH }}/.env.live << 'ENVEOF'
          CREAM_ENV=${{ vars.CREAM_ENV || 'PAPER' }}
          TURSO_DATABASE_URL=${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN=${{ secrets.TURSO_AUTH_TOKEN }}
          ALPACA_KEY=${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET=${{ secrets.ALPACA_SECRET }}
          POLYGON_KEY=${{ secrets.POLYGON_KEY }}
          DATABENTO_KEY=${{ secrets.DATABENTO_KEY }}
          FMP_KEY=${{ secrets.FMP_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          KALSHI_API_KEY_ID=${{ secrets.KALSHI_API_KEY_ID }}
          KALSHI_PRIVATE_KEY_PATH=${{ secrets.KALSHI_PRIVATE_KEY_PATH }}
          TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
          ENVEOF"

  # Deploy Dashboard (Next.js)
  deploy-dashboard:
    runs-on: ubuntu-latest
    needs: [changes, sync]
    if: |
      always() &&
      needs.sync.result == 'success' &&
      (needs.changes.outputs.dashboard == 'true' || inputs.force_deploy_all == true)
    environment: production
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          for i in {1..3}; do
            if ssh-keyscan -T 30 -H ${{ env.DOMAIN }} >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "SSH key scan successful"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "::error::Failed to scan SSH host after 3 attempts"
          exit 1

      - name: Deploy Dashboard
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=20 ${{ env.DEPLOY_USER }}@${{ env.DOMAIN }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "Building and deploying Dashboard..."
            docker compose -f docker-compose.prod.yml build dashboard
            docker compose -f docker-compose.prod.yml up -d --force-recreate dashboard
            echo "Waiting for Dashboard health check..."
            sleep 10
            docker compose -f docker-compose.prod.yml ps dashboard
          EOF

  # Deploy Dashboard API (Hono)
  deploy-dashboard-api:
    runs-on: ubuntu-latest
    needs: [changes, sync]
    if: |
      always() &&
      needs.sync.result == 'success' &&
      (needs.changes.outputs.dashboard_api == 'true' || inputs.force_deploy_all == true)
    environment: production
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          for i in {1..3}; do
            if ssh-keyscan -T 30 -H ${{ env.DOMAIN }} >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "SSH key scan successful"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "::error::Failed to scan SSH host after 3 attempts"
          exit 1

      - name: Deploy Dashboard API
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=20 ${{ env.DEPLOY_USER }}@${{ env.DOMAIN }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "Building and deploying Dashboard API..."
            docker compose -f docker-compose.prod.yml build dashboard-api
            docker compose -f docker-compose.prod.yml up -d --force-recreate dashboard-api
            echo "Waiting for API health check..."
            sleep 10
            if ! docker compose -f docker-compose.prod.yml ps dashboard-api | grep -q "(healthy)"; then
              echo "=== Dashboard API Container Logs ==="
              docker compose -f docker-compose.prod.yml logs --tail=100 dashboard-api
              echo "==========================="
            fi
            docker compose -f docker-compose.prod.yml ps dashboard-api
          EOF

  # Deploy Worker (hourly scheduler)
  deploy-worker:
    runs-on: ubuntu-latest
    needs: [changes, sync, deploy-dashboard-api]
    if: |
      always() &&
      needs.sync.result == 'success' &&
      (needs.deploy-dashboard-api.result == 'success' || needs.deploy-dashboard-api.result == 'skipped') &&
      (needs.changes.outputs.worker == 'true' || inputs.force_deploy_all == true)
    environment: production
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          for i in {1..3}; do
            if ssh-keyscan -T 30 -H ${{ env.DOMAIN }} >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "SSH key scan successful"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "::error::Failed to scan SSH host after 3 attempts"
          exit 1

      - name: Deploy Worker
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=20 ${{ env.DEPLOY_USER }}@${{ env.DOMAIN }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "Building and deploying Worker..."
            docker compose -f docker-compose.prod.yml build worker
            docker compose -f docker-compose.prod.yml up -d --force-recreate worker
            echo "Waiting for Worker startup..."
            sleep 5
            docker compose -f docker-compose.prod.yml ps worker
          EOF

  # Start/reload Caddy reverse proxy
  deploy-caddy:
    runs-on: ubuntu-latest
    needs:
      - changes
      - sync
      - deploy-dashboard
      - deploy-dashboard-api
    if: |
      always() &&
      needs.sync.result == 'success'
    environment: production
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          for i in {1..3}; do
            if ssh-keyscan -T 30 -H ${{ env.DOMAIN }} >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "SSH key scan successful"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "::error::Failed to scan SSH host after 3 attempts"
          exit 1

      - name: Reload or Start Caddy
        env:
          CADDY_CHANGED: ${{ needs.changes.outputs.caddy }}
          DOCKER_COMPOSE_CHANGED: ${{ needs.changes.outputs.docker_compose }}
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=20 ${{ env.DEPLOY_USER }}@${{ env.DOMAIN }} << EOF
            cd ${{ env.DEPLOY_PATH }}

            # Check if Caddy is already running
            CADDY_RUNNING=\$(docker compose -f docker-compose.prod.yml ps caddy --format json 2>/dev/null | grep -c '"running"' || echo "0")

            if [[ "$CADDY_CHANGED" == "true" ]] || [[ "$DOCKER_COMPOSE_CHANGED" == "true" ]]; then
              echo "Caddyfile or docker-compose changed - full Caddy restart..."
              docker compose -f docker-compose.prod.yml up -d --force-recreate caddy
              echo "Waiting for Caddy to be ready..."
              sleep 10
            elif [[ "\$CADDY_RUNNING" == "0" ]]; then
              echo "Caddy not running - starting it..."
              docker compose -f docker-compose.prod.yml up -d caddy
              echo "Waiting for Caddy to be ready..."
              sleep 10
            else
              echo "Caddy already running and no config changes - skipping restart"
            fi

            docker compose -f docker-compose.prod.yml ps
          EOF

  # Cleanup old Docker images
  cleanup:
    runs-on: ubuntu-latest
    needs: [deploy-caddy, sync]
    if: |
      always() &&
      needs.deploy-caddy.result == 'success'
    environment: production
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          for i in {1..3}; do
            if ssh-keyscan -T 30 -H ${{ env.DOMAIN }} >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "SSH key scan successful"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "::error::Failed to scan SSH host after 3 attempts"
          exit 1

      - name: Prune old Docker images
        run: |
          ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=20 ${{ env.DEPLOY_USER }}@${{ env.DOMAIN }} << 'EOF'
            echo "Pruning unused Docker images..."
            docker image prune -af
            echo ""
            echo "Pruning Docker build cache..."
            docker builder prune -af
            echo ""
            echo "Disk usage after cleanup:"
            docker system df
            df -h /
          EOF

  # Summary job
  summary:
    runs-on: ubuntu-latest
    needs:
      - changes
      - infrastructure
      - sync
      - deploy-dashboard
      - deploy-dashboard-api
      - deploy-worker
      - deploy-caddy
      - cleanup
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.changes.outputs.infra }} | ${{ needs.infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | ${{ needs.changes.outputs.dashboard }} | ${{ needs.deploy-dashboard.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard API | ${{ needs.changes.outputs.dashboard_api }} | ${{ needs.deploy-dashboard-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | ${{ needs.changes.outputs.worker }} | ${{ needs.deploy-worker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Compose | ${{ needs.changes.outputs.docker_compose }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Caddy | ${{ needs.changes.outputs.caddy }} | ${{ needs.deploy-caddy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard: https://cream.broker" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://api.cream.broker" >> $GITHUB_STEP_SUMMARY
          echo "- WebSocket: wss://api.cream.broker/ws" >> $GITHUB_STEP_SUMMARY
