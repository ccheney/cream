name: Buf Breaking Check

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "packages/schema/**"

concurrency:
  group: buf-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Buf Lint and Breaking Change Detection
  # ============================================
  buf:
    name: Buf Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current
        uses: actions/checkout@v6

      - name: Setup Buf
        uses: bufbuild/buf-action@v1
        with:
          # Path to the Buf module
          input: packages/schema

          # Run lint check
          lint: true

          # Run breaking change detection
          breaking: true

          # Compare against master branch
          breaking_against: "https://github.com/${{ github.repository }}.git#branch=master,subdir=packages/schema"

  # ============================================
  # Protobuf Generation Check
  # ============================================
  generate:
    name: Buf Generate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Generate Protobuf code
        run: buf generate
        working-directory: packages/schema

      - name: Format generated code
        run: bunx @biomejs/biome check --write packages/schema-gen/

      - name: Check for uncommitted changes
        run: |
          if [[ -n $(git status --porcelain packages/schema-gen/) ]]; then
            echo "Error: Generated code is out of sync with proto files"
            echo "Please run 'buf generate' and commit the changes"
            git diff packages/schema-gen/
            exit 1
          fi
          echo "Generated code is in sync"
