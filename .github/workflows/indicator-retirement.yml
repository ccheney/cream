# Indicator Retirement Workflow
#
# Creates a PR to retire an indicator from production.
# Triggered manually or automatically when retirement conditions are met.
#
# Reference: docs/plans/19-dynamic-indicator-synthesis.md (lines 1206-1243)

name: Indicator Retirement

on:
  workflow_dispatch:
    inputs:
      indicator_id:
        description: "Indicator ID to retire"
        required: true
        type: string
      indicator_name:
        description: "Indicator name (for branch and PR)"
        required: true
        type: string
      reason:
        description: "Reason for retirement"
        required: true
        type: string
      avg_ic:
        description: "Final 30-day average IC (optional)"
        required: false
        type: string
      consecutive_low_days:
        description: "Consecutive days with low IC (optional)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: indicator-retirement-${{ github.event.inputs.indicator_id }}
  cancel-in-progress: false

env:
  CREAM_ENV: BACKTEST
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  create-retirement-pr:
    name: Create Retirement PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        run: |
          BRANCH_NAME="retire/${{ inputs.indicator_name }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Add deprecation comment to indicator file
        run: |
          NAME="${{ inputs.indicator_name }}"
          REASON="${{ inputs.reason }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Find the indicator file (check all category directories)
          for dir in momentum trend volatility volume custom; do
            FILE="packages/indicators/src/${dir}/${NAME}.ts"
            if [ -f "$FILE" ]; then
              echo "Found indicator at: $FILE"

              # Create deprecation header
              HEADER="/**
           * @deprecated RETIRED: ${DATE}
           * Indicator: ${NAME}
           * Reason: ${REASON}
           *
           * This indicator is no longer in active use.
           * Kept for historical reference - DO NOT DELETE.
           */

          "
              # Prepend header to file
              echo "$HEADER" | cat - "$FILE" > temp && mv temp "$FILE"
              echo "Added deprecation comment to $FILE"
              break
            fi
          done

      - name: Run linting
        run: bun run lint || true

      - name: Commit changes
        run: |
          git add .
          git commit -m "chore(indicators): retire ${{ inputs.indicator_name }}

          Reason: ${{ inputs.reason }}

          This indicator is being retired from active use.
          Source file preserved for historical reference." || echo "No changes to commit"

      - name: Push branch
        run: git push -u origin "$BRANCH_NAME" || echo "Branch already exists"

      - name: Create PR body
        id: pr_body
        run: |
          cat << 'PREOF' > pr_body.md
          ## Indicator Retirement

          ### Indicator: ${{ inputs.indicator_name }}
          ID: `${{ inputs.indicator_id }}`

          ### Reason for Retirement
          ${{ inputs.reason }}

          ### Final Metrics
          | Metric | Value |
          |--------|-------|
          | 30-day IC | ${{ inputs.avg_ic || 'N/A' }} |
          | Consecutive Low IC Days | ${{ inputs.consecutive_low_days || 'N/A' }} |

          ### Checklist
          - [x] Indicator status updated to retired in database
          - [x] Source file preserved with deprecation comment
          - [x] Activity log updated
          - [ ] Human review of retirement decision
          - [ ] Remove from category exports (if needed)
          PREOF

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "chore(indicators): retire ${{ inputs.indicator_name }}" \
            --body-file pr_body.md \
            --base master \
            --head "$BRANCH_NAME" \
            --label "indicator-retirement" || echo "PR already exists"

      - name: Output PR URL
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr view "$BRANCH_NAME" --json url -q .url 2>/dev/null || echo "")
          if [ -n "$PR_URL" ]; then
            echo "Created/Updated PR: $PR_URL"
          fi
