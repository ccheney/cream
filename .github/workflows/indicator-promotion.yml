# Indicator Promotion Workflow
#
# Creates a PR to promote a validated indicator from custom/ to production.
# Triggered manually after paper trading validation passes.
#
# Reference: docs/plans/19-dynamic-indicator-synthesis.md (lines 1029-1137)

name: Indicator Promotion

on:
  workflow_dispatch:
    inputs:
      indicator_id:
        description: "Indicator ID to promote"
        required: true
        type: string
      skip_validation:
        description: "Skip validation check (for testing only)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: indicator-promotion-${{ github.event.inputs.indicator_id }}
  cancel-in-progress: false

env:
  CREAM_ENV: BACKTEST
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  validate:
    name: Validate Indicator
    runs-on: ubuntu-latest
    outputs:
      name: ${{ steps.metadata.outputs.name }}
      category: ${{ steps.metadata.outputs.category }}
      hypothesis: ${{ steps.metadata.outputs.hypothesis }}
      rationale: ${{ steps.metadata.outputs.rationale }}
      validation_json: ${{ steps.metadata.outputs.validation_json }}
      paper_json: ${{ steps.metadata.outputs.paper_json }}
      is_valid: ${{ steps.metadata.outputs.is_valid }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Fetch indicator metadata
        id: metadata
        run: bun run scripts/fetch-indicator-metadata.ts ${{ inputs.indicator_id }}
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}

      - name: Check validation status
        if: ${{ !inputs.skip_validation }}
        run: |
          if [ "${{ steps.metadata.outputs.is_valid }}" != "true" ]; then
            echo "::error::Indicator has not passed validation"
            exit 1
          fi

  create-pr:
    name: Create Promotion PR
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ needs.validate.outputs.is_valid == 'true' || inputs.skip_validation }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        run: |
          BRANCH_NAME="indicator/${{ needs.validate.outputs.name }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Move indicator to production category
        run: |
          NAME="${{ needs.validate.outputs.name }}"
          CATEGORY="${{ needs.validate.outputs.category }}"

          # Move indicator file
          if [ -f "packages/indicators/src/custom/${NAME}.ts" ]; then
            mv "packages/indicators/src/custom/${NAME}.ts" \
               "packages/indicators/src/${CATEGORY}/"
          fi

          # Move test file if exists
          if [ -f "packages/indicators/src/custom/${NAME}.test.ts" ]; then
            mv "packages/indicators/src/custom/${NAME}.test.ts" \
               "packages/indicators/src/${CATEGORY}/"
          fi

      - name: Update exports
        run: |
          bun run scripts/update-indicator-exports.ts \
            "${{ needs.validate.outputs.name }}" \
            "${{ needs.validate.outputs.category }}"

      - name: Run tests
        run: bun test packages/indicators

      - name: Commit changes
        run: |
          git add .
          git commit -m "feat(indicators): add ${{ needs.validate.outputs.name }} indicator

          Promotes indicator from custom/ to ${{ needs.validate.outputs.category }}/ category
          after passing paper trading validation."

      - name: Push branch
        run: git push -u origin "$BRANCH_NAME"

      - name: Create PR body
        id: pr_body
        run: |
          cat << 'PREOF' > pr_body.md
          ## New Indicator: ${{ needs.validate.outputs.name }}

          ### Hypothesis
          ${{ needs.validate.outputs.hypothesis }}

          ### Economic Rationale
          ${{ needs.validate.outputs.rationale }}

          ### Validation Results
          See validation report in indicator metadata.

          Indicator ID: `${{ inputs.indicator_id }}`

          ### Checklist
          - [x] All validation gates passed
          - [x] Paper trading period completed
          - [x] Code follows packages/indicators patterns
          - [x] Tests pass
          - [ ] Human reviewer approved economic rationale
          PREOF

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "feat(indicators): add ${{ needs.validate.outputs.name }} indicator" \
            --body-file pr_body.md \
            --base master \
            --head "$BRANCH_NAME" \
            --label "indicator-promotion"

      - name: Update indicator with PR URL
        run: |
          PR_URL=$(gh pr view "$BRANCH_NAME" --json url -q .url)
          echo "Created PR: $PR_URL"
          # Note: Update indicator.pr_url in database would happen here
          # via a separate API call or script
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
